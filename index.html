<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ExtraTvLive</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ExtraTvLive" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon-180x180.png" />
  <meta name="theme-color" content="#f97316" />

  <style>
    :root { --brand:#f97316; }
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .safe { padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right); }
    .splash-screen { position:fixed; inset:0; background:#f97316; display:flex; align-items:center; justify-content:center; z-index:50; opacity:1; transition:opacity 600ms ease; }
    .splash-screen.hidden { opacity:0; pointer-events:none; }
    .container { max-width:600px; margin: max(1rem, env(safe-area-inset-top)) auto 1rem; padding:1rem; border-radius:1rem; box-shadow:0 4px 10px rgba(0,0,0,.05); transition:opacity 400ms ease; }
    .video-container { position:relative; width:100%; padding-top:56.25%; border-radius:1rem; overflow:hidden; background:#000; box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); }
    .video-player { position:absolute; inset:0; width:100%; height:100%; object-fit:contain; background:#000; border:none; }
    @media (prefers-color-scheme: dark){
      body { background:#1e1e1e; color:#e5e7eb; }
      .container { background:#1e1e1e; box-shadow:0 4px 10px rgba(255,255,255,.05); }
    }
  </style>
</head>
<body class="bg-white text-gray-800">
  <div id="splash" class="splash-screen">
    <h1 class="text-3xl font-bold text-white">ExtraTvLive</h1>
  </div>

  <main id="app" class="container bg-white dark:bg-[#1e1e1e] safe">
    <h1 class="text-3xl font-bold text-orange-500">ExtraTvLive</h1>
    <p class="text-xl font-semibold text-gray-600 dark:text-gray-300">Streaming dal vivo, sempre con te.</p>

    <div class="video-container mt-4">
      <!-- NIENTE autoplay; mutato di default; niente crossorigin per iOS nativo -->
      <video id="video" class="video-player" playsinline muted controls preload="metadata"
             src="">
        Il tuo browser non supporta il tag video.
      </video>
    </div>

    <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mt-2">Tocca <strong>Avvia Riproduzione</strong> (o il video) per iniziare. Doppio tap per Full‑Screen.</p>

    <div class="flex flex-wrap gap-3 justify-center mt-3">
      <button id="main-button" class="px-5 py-3 rounded-full font-semibold shadow bg-[color:var(--brand)] text-white hover:opacity-90 min-w-[180px]">Avvia Riproduzione</button>
      <button id="audio-button" class="px-5 py-3 rounded-full font-semibold shadow bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600 min-w-[160px]">Attiva Audio</button>
      <button id="pip-button" class="px-5 py-3 rounded-full font-semibold shadow bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-100 dark:hover:bg-gray-600 min-w-[160px]">Entra in PiP</button>
    </div>

    <p id="msg" class="text-sm text-gray-500 dark:text-gray-400 mt-1"></p>

    <footer class="mt-6 text-center">
      <div class="space-x-3 text-2xl">
        <a href="https://www.facebook.com/extratvitaly" target="_blank" rel="noopener"><i class="fa-brands fa-facebook-square"></i></a>
        <a href="https://www.instagram.com/extratv_official/" target="_blank" rel="noopener"><i class="fa-brands fa-instagram"></i></a>
        <a href="https://www.youtube.com/@ExtraTvItaly" target="_blank" rel="noopener"><i class="fa-brands fa-youtube-square"></i></a>
      </div>
      <p class="text-xs text-gray-400 mt-2">© 2025 ExtraTv Live. Tutti i diritti riservati.</p>
    </footer>
  </main>

  <script src="ios-install-hint.js" defer></script>
  <script>
    (function(){
      const videoUrl = "https://rst2.saiuzwebnetwork.it:8081/extratvlive/index.m3u8";
      const splash = document.getElementById('splash');
      const video = document.getElementById('video');
      const mainBtn = document.getElementById('main-button');
      const audioBtn = document.getElementById('audio-button');
      const pipBtn = document.getElementById('pip-button');
      const msg = document.getElementById('msg');
      let hls, started = false;

      if ('serviceWorker' in navigator){
        window.addEventListener('load', ()=>{
          navigator.serviceWorker.register('./service-worker.js').catch(console.warn);
        });
      }
      window.addEventListener('load', ()=> setTimeout(()=> splash.classList.add('hidden'), 600));

      function showMessage(text, t=3000){ msg.textContent = text; setTimeout(()=> msg.textContent='', t); }

      const isIOS = /iP(hone|ad|od)/.test(navigator.platform) || (navigator.userAgent.includes('Mac') && 'ontouchend' in document);

      async function startOnce(){
        if (started) return;
        started = true;
        try { if (hls) { hls.destroy(); hls = null; } } catch(e){}
        if (isIOS || !window.Hls || !Hls.isSupported()){
          // iOS nativo: niente crossorigin, partire MUTED
          video.removeAttribute('crossorigin');
          video.src = videoUrl;
          video.load();
          try { await video.play(); } catch(e) { showMessage('Premi di nuovo Avvia se non parte.'); }
        } else {
          // hls.js per altri browser
          try { video.setAttribute('crossorigin', 'anonymous'); } catch(e){}
          hls = new Hls({ manifestLoadingTimeOut: 10000, liveSyncDuration: 3, liveMaxLatencyDuration: 10, liveDuration: 30 });
          hls.loadSource(videoUrl);
          hls.attachMedia(video);
          hls.on(Hls.Events.MEDIA_ATTACHED, () => video.play().catch(()=>{}));
        }
      }

      function toggleAudio(){
        // NON smutare automaticamente alla partenza per evitare blocchi su iOS/PWA
        video.muted = !video.muted;
        audioBtn.textContent = video.muted ? 'Attiva Audio' : 'Disattiva Audio';
      }

      mainBtn.addEventListener('click', startOnce);
      // Avvio anche toccando il video (tap singolo)
      video.addEventListener('touchend', startOnce, { once: true, passive: true });
      video.addEventListener('click', startOnce, { once: true });

      audioBtn.addEventListener('click', toggleAudio);

      // PiP
      pipBtn.addEventListener('click', async () => {
        if (!('pictureInPictureEnabled' in document)) return showMessage('Il PiP non è supportato.');
        try { if(document.pictureInPictureElement){ await document.exitPictureInPicture(); } else { if(video.paused) await video.play(); await video.requestPictureInPicture(); } }
        catch(e){ showMessage('Impossibile attivare PiP.'); }
      });

      // Doppio tap = full screen
      let lastTap = 0;
      video.addEventListener('click', (ev)=>{
        const now = Date.now();
        if(now - lastTap < 300){
          if(document.fullscreenElement){ document.exitFullscreen(); }
          else if(video.webkitEnterFullscreen){ if(document.webkitFullscreenElement) document.webkitExitFullscreen(); else video.webkitEnterFullscreen(); }
          else if(video.requestFullscreen){ video.requestFullscreen(); }
        }
        lastTap = now;
      });

      // Alcuni iOS mostrano solo il primo frame finché non c'è play attivo; se va in pausa, riprova
      video.addEventListener('pause', () => { /* opzionale: potresti voler evitare autoplay loop */ });
      video.addEventListener('error', () => { console.warn('Video error code:', video.error && video.error.code); });
    })();
  </script>
</body>
</html>
